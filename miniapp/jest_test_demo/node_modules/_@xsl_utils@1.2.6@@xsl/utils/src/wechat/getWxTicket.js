import request from '../request'
import getWechatToken from './getWechatToken'
import config from './wxConfig'

const { logger } = config
let wechatTicketInfo = {}
export default async function getWechatTicket() {
  const { wxConfig } = config
  const { wechatTicket, wechatAccessTokenExpirse } = wechatTicketInfo
  // ticket的有效期为7200秒 (这里是3600秒时重新获取)
  if (!wechatTicket || wechatAccessTokenExpirse + (3600 * 1000) < Date.now()) {
    wechatTicketInfo = await getWechatToken()
    const response = await request.get(wxConfig.ticketUrl, {
      access_token: wechatTicketInfo.wechatAccessToken,
      type: 'jsapi',
    })
    const newWechatTicket = response.ticket
    if (!newWechatTicket) logger.error('获取wechat ticket失败', response)
    wechatTicketInfo.wechatTicket = newWechatTicket
    wechatTicketInfo.wechatAccessTokenExpirse = Date.now()
  }

  return wechatTicketInfo.wechatTicket
}

import CryptoJS from 'crypto-js'
import fetchWxTicket from './getWxTicket'
import config from './wxConfig'

const { logger } = config
export default async (req, res, next) => { // eslint-disable-line
  const { wxConfig } = config
  try {
    const { fullPath } = req.query
    const currentUrl = `${wxConfig.domain}${fullPath}`
    const wechatTicket = await fetchWxTicket()
    const timestamp = Math.floor(Date.now() / 1000)
    const nonceStr = Math.random().toString(32).substr(2, 15)
    const string1 = `jsapi_ticket=${wechatTicket}&noncestr=${nonceStr}&timestamp=${timestamp}&url=${currentUrl}`
    const signature = CryptoJS.SHA1(string1).toString()  // eslint-disable-line
    const wxSdkConfig = { signature, nonceStr, timestamp }
    wxSdkConfig.appId = wxConfig.appId
    return res.json({ wxSdkConfig, apiList: config.apiList })
  } catch (e) {
    logger.error('error when getWxSdkConfig:', e.stack)
  }
  next()
}

import request from '../request'
import config from './wxConfig'

const { logger } = config
const wechatTokenInfo = {}
export default async function fetchWechatToken() {
  const { appId, appSecret, tokenUrl } = config
  const { wechatAccessToken, wechatAccessTokenExpirse } = wechatTokenInfo
  // ticket的有效期为7200秒 (这里是3600秒时重新获取)
  if (!wechatAccessToken || wechatAccessTokenExpirse + (3600 * 1000) < Date.now()) {
    const response = await request.get(tokenUrl, {
      appid: appId,
      secret: appSecret,
      grant_type: 'client_credential',
    })
    if (!response.access_token) {
      logger.error('error when get wechat access_token')
    }
    wechatTokenInfo.wechatAccessToken = response.access_token
    wechatTokenInfo.wechatAccessTokenExpirse = Date.now()
  }
  return wechatTokenInfo
}

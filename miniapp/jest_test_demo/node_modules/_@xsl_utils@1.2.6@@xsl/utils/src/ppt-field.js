import { unnest, uniq, sort, ascend } from 'ramda'
import { getAllCaptureGroups } from './regexp'

function getFieldUidsAndPatients(formulaArr) {
  const reg = /\$(\d+)\[(\d+)\]/g
  const mergedArr = unnest(formulaArr.map(formula => getAllCaptureGroups({ str: formula, regExp: reg })))
  if (mergedArr.some(v => v[2] === undefined)) {
    throw new Error('有错误的公式，不可缺少病例序号')
  }
  return {
    fieldIndexes: sort(ascend(v => v), uniq(mergedArr.map(v => +v[1]))),
    patientIndexes: sort(ascend(v => v), uniq(mergedArr.map(v => +v[2]))),
  }
}

export default { getFieldUidsAndPatients }

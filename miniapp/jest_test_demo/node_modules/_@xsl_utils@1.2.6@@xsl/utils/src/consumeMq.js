import amqp from 'amqplib'
import config from './config'

export default async ({ vhost, exchange, exchangeType, routingKey, queue, consume }) => {
  const { amqpDomain } = config
  const {
    name,
    options: { assert, bind },
  } = queue
  const { consumeHandler, options } = consume
  const url = `${amqpDomain}/${vhost}`
  try {
    const connection = await amqp.connect(url)
    const channel = await connection.createChannel()
    await channel.assertExchange(exchange, exchangeType, { durable: true })
    await channel.assertQueue(name, assert)
    await channel.bindQueue(name, exchange, routingKey, bind)
    await channel.consume(
      name,
      async msg => {
        consumeHandler.apply(consume, [msg, { channel, exchange, queue }])
      },
      options
    )
  } catch (e) {
    console.error(`consume 消息错误, routing key is ${routingKey}`, e)
  }
}

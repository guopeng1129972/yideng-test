import request from 'superagent'
import R from 'ramda'
import { mobileRegex } from './lang'
import config from './config'

/**
 * 通过短信服务发送短息
 *
 * @param mobile 字符串和数字均可
 * @returns 如果发生错误, 会抛出异常, 包含错误信息
 */
export default async ({ mobile, content, channel = '0' }) => {
  if (!mobileRegex.test(mobile)) throw new Error('不是有效的手机号码')
  if (!content) throw new Error('发送内容为空')
  try {
    await request.post(config.smsApiUrl).send({
      mobile: Number(mobile),
      content,
      channel,
    })
  } catch (err) {
    throw new Error(R.path(['msg'])(JSON.parse(R.path(['response', 'text'])(err))) || '未知错误')
  }
}

import amqp from 'amqplib'
import config from './config'

export default async ({ vhost, exchange, exchangeType, routingKey, data }) => {
  const { amqpDomains } = config
  const i = Math.floor(Math.random() * amqpDomains.length)
  const url = `${amqpDomains[i]}/${vhost}`

  const connection = await amqp.connect(url)
  try {
    const channel = await connection.createChannel()
    await channel.assertExchange(exchange, exchangeType, { durable: true })
    await channel.publish(exchange, routingKey, Buffer.from(JSON.stringify(data)))
    await channel.close()
  } catch (e) {
    console.error(`publish 消息错误, routing key is ${routingKey}`, e)
  } finally {
    connection.close()
  }
}

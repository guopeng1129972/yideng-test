'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.temp = undefined;
exports.makeRequest = makeRequest;

var _crypto = require('crypto');

var _crypto2 = _interopRequireDefault(_crypto);

var _config = require('./config');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var expires = 3600;

function base64ToUrlSafe(v) {
  return v.replace(/\//g, '_').replace(/\+/g, '-');
}

function hmacSha1(encodedFlags, secretKey) {
  var hmac = _crypto2.default.createHmac('sha1', secretKey);
  hmac.update(encodedFlags);
  return hmac.digest('base64');
}

function makeRequest(url) {
  var baseUrl = url;
  var deadline = expires + Math.floor(Date.now() / 1000);

  if (baseUrl.indexOf('?') >= 0) {
    baseUrl += '&e=';
  } else {
    baseUrl += '?e=';
  }
  baseUrl += deadline;

  var signature = hmacSha1(baseUrl, _config.qiniu.SECRET_KEY);
  var encodedSign = base64ToUrlSafe(signature);
  var downloadToken = _config.qiniu.ACCESS_KEY + ':' + encodedSign;

  return baseUrl + '&token=' + downloadToken;
}

var temp = exports.temp = null;
//# sourceMappingURL=qiniu.js.map